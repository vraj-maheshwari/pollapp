<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Creator Dashboard - {{ question }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <div class="row">
      <div class="col-12">
        <div class="card shadow-sm mb-4">
          <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ðŸŽ¯ Creator Dashboard</h5>
            <span class="badge bg-light text-dark">{{ total }} votes</span>
          </div>
          <div class="card-body">
            <h6 class="text-muted mb-3">{{ question }}</h6>
            
            <div class="row mb-4">
              <div class="col-md-4">
                <div class="card bg-primary text-white">
                  <div class="card-body text-center">
                    <h3>{{ total }}</h3>
                    <small>Total Votes</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card bg-info text-white">
                  <div class="card-body text-center">
                    <h3>{{ (created_at.strftime('%m/%d') if created_at else 'N/A') }}</h3>
                    <small>Created</small>
                  </div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="card {% if is_expired %}bg-danger{% else %}bg-warning{% endif %} text-white">
                  <div class="card-body text-center">
                    <h3>{{ expiry_dt.strftime('%H:%M') if expiry_dt else 'N/A' }}</h3>
                    <small>{% if is_expired %}Expired{% else %}Expires{% endif %}</small>
                  </div>
                </div>
              </div>
            </div>

            {% if insights %}
            <div class="alert alert-info">
              <h6><i class="bi bi-lightbulb"></i> AI Insights (20+ votes)</h6>
              <p class="mb-0">{{ insights }}</p>
            </div>
            {% endif %}

            <div class="d-flex gap-2 mb-3">
              <a href="{{ poll_link }}" class="btn btn-primary" target="_blank">View Poll</a>
              <button class="btn btn-outline-secondary" onclick="copyLink('{{ poll_link }}')">Copy Link</button>
              <a href="{{ url_for('qr_code', poll_id=poll_id) }}" class="btn btn-outline-dark" target="_blank">QR Code</a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-8">
        <div class="card shadow-sm">
          <div class="card-header">
            <h6 class="mb-0">Live Results</h6>
          </div>
          <div class="card-body">
            <div id="resultsContainer">
              {% for text, count, opt_id, percentage in results %}
              <div class="mb-3">
                <div class="d-flex justify-content-between">
                  <strong>{{ text }}</strong>
                  <span>{{ count }} votes ({{ "%.1f"|format(percentage) }}%)</span>
                </div>
                <div class="progress">
                  <div class="progress-bar" role="progressbar" style="width: {{ percentage }}%"></div>
                </div>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-lg-4">
        <div class="card shadow-sm">
          <div class="card-header">
            <h6 class="mb-0">Vote Timeline</h6>
          </div>
          <div class="card-body">
            {% if timeline %}
              {% for day in timeline %}
              <div class="d-flex justify-content-between mb-2">
                <span>{{ day.vote_date }}</span>
                <span class="badge bg-primary">{{ day.count }}</span>
              </div>
              {% endfor %}
            {% else %}
              <p class="text-muted">No votes yet</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
let socket = null;
function initSocket(){
  socket = io();
  socket.on('vote_cast', (data)=>{ 
    if(data.poll_id == {{ poll_id }}) {
      updateResults();
      updateVoteCount(data.total_votes);
    }
  });
}

async function updateResults(){
  try{
    const r = await fetch('/api/results/{{ poll_id }}');
    const d = await r.json();
    const container = document.getElementById('resultsContainer');
    if(!container) return;
    
    container.innerHTML = d.results.map(x => `
      <div class="mb-3">
        <div class="d-flex justify-content-between">
          <strong>${x.text}</strong>
          <span>${x.count} votes (${x.percentage}%)</span>
        </div>
        <div class="progress">
          <div class="progress-bar" role="progressbar" style="width:${x.percentage}%"></div>
        </div>
      </div>`).join('');
  } catch(e){ console.error(e); }
}

function updateVoteCount(total) {
  const badges = document.querySelectorAll('.badge.bg-light.text-dark');
  badges.forEach(badge => {
    if (badge.textContent.includes('votes')) {
      badge.textContent = `${total} votes`;
    }
  });
}

function copyLink(link) {
  navigator.clipboard.writeText(link).then(() => {
    alert('Link copied to clipboard!');
  });
}

document.addEventListener('DOMContentLoaded', ()=>{ 
  initSocket(); 
  setInterval(updateResults, 5000); 
});
</script>
</body>
</html>